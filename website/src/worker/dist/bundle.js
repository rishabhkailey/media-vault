/*
 * ATTENTION: The "eval" devtool has been used (maybe by default in mode: "development").
 * This devtool is neither made for production nor for readable output files.
 * It uses "eval()" calls to create a separate source file in the browser devtools.
 * If you are trying to read the output file, select a different devtool (https://webpack.js.org/configuration/devtool/)
 * or disable the default devtool with "devtool: false".
 * If you are looking for production-ready output files, see mode: "production" (https://webpack.js.org/configuration/mode/).
 */
/******/ (() => { // webpackBootstrap
/******/ 	"use strict";
/******/ 	var __webpack_modules__ = ({

/***/ "../../node_modules/ts-chacha20/build/src/chacha20.js":
/*!************************************************************!*\
  !*** ../../node_modules/ts-chacha20/build/src/chacha20.js ***!
  \************************************************************/
/***/ ((__unused_webpack_module, exports) => {

eval("\n/*\n * Copyright (c) 2017, Bubelich Mykola\n * https://www.bubelich.com\n *\n * (｡◕‿‿◕｡)\n *\n * All rights reserved.\n *\n * Redistribution and use in source and binary forms, with or without\n * modification, are permitted provided that the following conditions are met, 0x\n *\n * Redistributions of source code must retain the above copyright notice,\n * this list of conditions and the following disclaimer.\n *\n * Redistributions in binary form must reproduce the above copyright notice,\n * this list of conditions and the following disclaimer in the documentation\n * and/or other materials provided with the distribution.\n *\n * Neither the name of the copyright holder nor the names of its contributors\n * may be used to endorse or promote products derived from this software without\n * specific prior written permission.\n *\n * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDER AND CONTRIBUTORS \"AS IS\"\n * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE\n * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE\n * ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE\n * LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR\n * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF\n * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS\n * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN\n * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)\n * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE\n * POSSIBILITY OF SUCH DAMAGE.\n *\n * ChaCha20 is a stream cipher designed by D. J. Bernstein.\n * It is a refinement of the Salsa20 algorithm, and it uses a 256-bit key.\n *\n * ChaCha20 successively calls the ChaCha20 block function, with the same key and nonce, and with successively increasing block counter parameters.\n * ChaCha20 then serializes the resulting state by writing the numbers in little-endian order, creating a keystream block.\n *\n * Concatenating the keystream blocks from the successive blocks forms a keystream.\n * The ChaCha20 function then performs an XOR of this keystream with the plaintext.\n * Alternatively, each keystream block can be XORed with a plaintext block before proceeding to create the next block, saving some memory.\n * There is no requirement for the plaintext to be an integral multiple of 512 bits.  If there is extra keystream from the last block, it is discarded.\n *\n * The inputs to ChaCha20 are\n * - 256-bit key\n * - 32-bit initial counter\n * - 96-bit nonce.  In some protocols, this is known as the Initialization Vector\n * - Arbitrary-length plaintext\n *\n * Implementation derived from chacha-ref.c version 20080118\n * See for details, 0x http, 0x//cr.yp.to/chacha/chacha-20080128.pdf\n */\nObject.defineProperty(exports, \"__esModule\", ({ value: true }));\nexports.Chacha20 = void 0;\n/**\n *\n * @param {Uint8Array} key\n * @param {Uint8Array} nonce\n * @param {number} counter\n * @throws {Error}\n *\n * @constructor\n */\nvar Chacha20 = /** @class */ (function () {\n    function Chacha20(key, nonce, counter) {\n        this.key = key;\n        this.nonce = nonce;\n        this.counter = counter;\n        this._rounds = 20;\n        // Constants\n        this._sigma = [0x61707865, 0x3320646e, 0x79622d32, 0x6b206574];\n        // internal byte counter //\n        this._byteCounter = 0;\n        if (!(key instanceof Uint8Array) || key.length !== 32) {\n            throw new Error('Key should be 32 byte array!');\n        }\n        if (!(nonce instanceof Uint8Array) || nonce.length !== 12) {\n            throw new Error('Nonce should be 12 byte array!');\n        }\n        if (!counter) {\n            this.counter = 0;\n        }\n        // param construction\n        this._param = [\n            this._sigma[0],\n            this._sigma[1],\n            this._sigma[2],\n            this._sigma[3],\n            // key\n            this._get32(key, 0),\n            this._get32(key, 4),\n            this._get32(key, 8),\n            this._get32(key, 12),\n            this._get32(key, 16),\n            this._get32(key, 20),\n            this._get32(key, 24),\n            this._get32(key, 28),\n            // counter\n            this.counter,\n            // nonce\n            this._get32(nonce, 0),\n            this._get32(nonce, 4),\n            this._get32(nonce, 8)\n        ];\n        // init 64 byte keystream block //\n        this._keystream = [\n            0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,\n            0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,\n            0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,\n            0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0\n        ];\n    }\n    Chacha20.prototype._chacha = function () {\n        var mix = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0];\n        var i = 0;\n        var b = 0;\n        // copy param array to mix //\n        for (i = 0; i < 16; i++) {\n            mix[i] = this._param[i];\n        }\n        // mix rounds //\n        for (i = 0; i < this._rounds; i += 2) {\n            this._quarterround(mix, 0, 4, 8, 12);\n            this._quarterround(mix, 1, 5, 9, 13);\n            this._quarterround(mix, 2, 6, 10, 14);\n            this._quarterround(mix, 3, 7, 11, 15);\n            this._quarterround(mix, 0, 5, 10, 15);\n            this._quarterround(mix, 1, 6, 11, 12);\n            this._quarterround(mix, 2, 7, 8, 13);\n            this._quarterround(mix, 3, 4, 9, 14);\n        }\n        for (i = 0; i < 16; i++) {\n            // add\n            mix[i] += this._param[i];\n            // store keystream\n            this._keystream[b++] = mix[i] & 0xFF;\n            this._keystream[b++] = (mix[i] >>> 8) & 0xFF;\n            this._keystream[b++] = (mix[i] >>> 16) & 0xFF;\n            this._keystream[b++] = (mix[i] >>> 24) & 0xFF;\n        }\n    };\n    /**\n     * The basic operation of the ChaCha algorithm is the quarter round.\n     * It operates on four 32-bit unsigned integers, denoted a, b, c, and d.\n     *\n     * @param {Array} output\n     * @param {number} a\n     * @param {number} b\n     * @param {number} c\n     * @param {number} d\n     * @private\n     */\n    Chacha20.prototype._quarterround = function (output, a, b, c, d) {\n        output[d] = this._rotl(output[d] ^ (output[a] += output[b]), 16);\n        output[b] = this._rotl(output[b] ^ (output[c] += output[d]), 12);\n        output[d] = this._rotl(output[d] ^ (output[a] += output[b]), 8);\n        output[b] = this._rotl(output[b] ^ (output[c] += output[d]), 7);\n        // JavaScript hack to make UINT32 :) //\n        output[a] >>>= 0;\n        output[b] >>>= 0;\n        output[c] >>>= 0;\n        output[d] >>>= 0;\n    };\n    /**\n     * Little-endian to uint 32 bytes\n     *\n     * @param {Uint8Array|[number]} data\n     * @param {number} index\n     * @return {number}\n     * @private\n     */\n    Chacha20.prototype._get32 = function (data, index) {\n        return data[index++] ^ (data[index++] << 8) ^ (data[index++] << 16) ^ (data[index] << 24);\n    };\n    /**\n     * Cyclic left rotation\n     *\n     * @param {number} data\n     * @param {number} shift\n     * @return {number}\n     * @private\n     */\n    Chacha20.prototype._rotl = function (data, shift) {\n        return ((data << shift) | (data >>> (32 - shift)));\n    };\n    /**\n     *  Encrypt data with key and nonce\n     *\n     * @param {Uint8Array} data\n     * @return {Uint8Array}\n     */\n    Chacha20.prototype.encrypt = function (data) {\n        return this._update(data);\n    };\n    /**\n     *  Decrypt data with key and nonce\n     *\n     * @param {Uint8Array} data\n     * @return {Uint8Array}\n     */\n    Chacha20.prototype.decrypt = function (data) {\n        return this._update(data);\n    };\n    /**\n     *  Encrypt or Decrypt data with key and nonce\n     *\n     * @param {Uint8Array} data\n     * @return {Uint8Array}\n     * @private\n     */\n    Chacha20.prototype._update = function (data) {\n        if (!(data instanceof Uint8Array) || data.length === 0) {\n            throw new Error('Data should be type of bytes (Uint8Array) and not empty!');\n        }\n        var output = new Uint8Array(data.length);\n        // core function, build block and xor with input data //\n        for (var i = 0; i < data.length; i++) {\n            if (this._byteCounter === 0 || this._byteCounter === 64) {\n                // generate new block //\n                this._chacha();\n                // counter increment //\n                this._param[12]++;\n                // reset internal counter //\n                this._byteCounter = 0;\n            }\n            output[i] = data[i] ^ this._keystream[this._byteCounter++];\n        }\n        return output;\n    };\n    return Chacha20;\n}());\nexports.Chacha20 = Chacha20;\n//# sourceMappingURL=chacha20.js.map\n\n//# sourceURL=webpack:///../../node_modules/ts-chacha20/build/src/chacha20.js?");

/***/ }),

/***/ "../js/channels/encryptionKey.ts":
/*!***************************************!*\
  !*** ../js/channels/encryptionKey.ts ***!
  \***************************************/
/***/ (function(__unused_webpack_module, exports, __webpack_require__) {

eval("\nvar __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {\n    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }\n    return new (P || (P = Promise))(function (resolve, reject) {\n        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }\n        function rejected(value) { try { step(generator[\"throw\"](value)); } catch (e) { reject(e); } }\n        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }\n        step((generator = generator.apply(thisArg, _arguments || [])).next());\n    });\n};\nvar __generator = (this && this.__generator) || function (thisArg, body) {\n    var _ = { label: 0, sent: function() { if (t[0] & 1) throw t[1]; return t[1]; }, trys: [], ops: [] }, f, y, t, g;\n    return g = { next: verb(0), \"throw\": verb(1), \"return\": verb(2) }, typeof Symbol === \"function\" && (g[Symbol.iterator] = function() { return this; }), g;\n    function verb(n) { return function (v) { return step([n, v]); }; }\n    function step(op) {\n        if (f) throw new TypeError(\"Generator is already executing.\");\n        while (g && (g = 0, op[0] && (_ = 0)), _) try {\n            if (f = 1, y && (t = op[0] & 2 ? y[\"return\"] : op[0] ? y[\"throw\"] || ((t = y[\"return\"]) && t.call(y), 0) : y.next) && !(t = t.call(y, op[1])).done) return t;\n            if (y = 0, t) op = [op[0] & 2, t.value];\n            switch (op[0]) {\n                case 0: case 1: t = op; break;\n                case 4: _.label++; return { value: op[1], done: false };\n                case 5: _.label++; y = op[1]; op = [0]; continue;\n                case 7: op = _.ops.pop(); _.trys.pop(); continue;\n                default:\n                    if (!(t = _.trys, t = t.length > 0 && t[t.length - 1]) && (op[0] === 6 || op[0] === 2)) { _ = 0; continue; }\n                    if (op[0] === 3 && (!t || (op[1] > t[0] && op[1] < t[3]))) { _.label = op[1]; break; }\n                    if (op[0] === 6 && _.label < t[1]) { _.label = t[1]; t = op; break; }\n                    if (t && _.label < t[2]) { _.label = t[2]; _.ops.push(op); break; }\n                    if (t[2]) _.ops.pop();\n                    _.trys.pop(); continue;\n            }\n            op = body.call(thisArg, _);\n        } catch (e) { op = [6, e]; y = 0; } finally { f = t = 0; }\n        if (op[0] & 5) throw op[1]; return { value: op[0] ? op[1] : void 0, done: true };\n    }\n};\nObject.defineProperty(exports, \"__esModule\", ({ value: true }));\nexports.EncryptionKeyChannelWorker = exports.EncryptionKeyChannelClient = void 0;\nvar utils_1 = __webpack_require__(/*! ../utils */ \"../js/utils.ts\");\nvar channelName = \"encryption-key-channel\";\nvar EncryptionKeyChannelClient = /** @class */ (function () {\n    function EncryptionKeyChannelClient(encryptionKey) {\n        var _this = this;\n        this._channel = new BroadcastChannel(channelName);\n        this._encryptionKey = encryptionKey;\n        this._channel.addEventListener(\"message\", function (event) {\n            console.log(\"\".concat((0, utils_1.timestamp)(), \": client: want encryption key message received\"));\n            if (event.data.wantEncryptionKey !== true) {\n                return;\n            }\n            _this._channel.postMessage({\n                encryptionKey: _this._encryptionKey,\n            });\n        });\n    }\n    Object.defineProperty(EncryptionKeyChannelClient.prototype, \"encryptionKey\", {\n        set: function (encryptionKey) {\n            this._encryptionKey = encryptionKey;\n            this._channel.postMessage({\n                encryptionKey: encryptionKey,\n            });\n        },\n        enumerable: false,\n        configurable: true\n    });\n    return EncryptionKeyChannelClient;\n}());\nexports.EncryptionKeyChannelClient = EncryptionKeyChannelClient;\nvar EncryptionKeyChannelWorker = /** @class */ (function () {\n    function EncryptionKeyChannelWorker() {\n        var _this = this;\n        this._channel = new BroadcastChannel(channelName);\n        this._encryptionKey = \"\";\n        this._requestEncryptionKeyInProgress = false;\n        this._channel.addEventListener(\"message\", function (event) {\n            var _a;\n            if (((_a = event.data) === null || _a === void 0 ? void 0 : _a.encryptionKey) &&\n                typeof event.data.encryptionKey === \"string\" &&\n                event.data.encryptionKey.length !== 0) {\n                console.log(\"\".concat((0, utils_1.timestamp)(), \": worker: set encryption key message received\"));\n                _this._encryptionKey = event.data.encryptionKey;\n                return;\n            }\n        });\n    }\n    Object.defineProperty(EncryptionKeyChannelWorker.prototype, \"encryptionKey\", {\n        get: function () {\n            return this._encryptionKey;\n        },\n        enumerable: false,\n        configurable: true\n    });\n    EncryptionKeyChannelWorker.prototype.requestEncryptionKey = function () {\n        return __awaiter(this, void 0, void 0, function () {\n            var interval_1, timeout, time, err_1;\n            return __generator(this, function (_a) {\n                switch (_a.label) {\n                    case 0:\n                        if (this.encryptionKey.length !== 0) {\n                            return [2 /*return*/, this.encryptionKey];\n                        }\n                        if (this._requestEncryptionKeyInProgress === false) {\n                            console.debug(\"\".concat((0, utils_1.timestamp)(), \": requesting encryption key from client\"));\n                            this._channel.postMessage({\n                                wantEncryptionKey: true,\n                            });\n                            this._requestEncryptionKeyInProgress = true;\n                        }\n                        _a.label = 1;\n                    case 1:\n                        _a.trys.push([1, 5, 6, 7]);\n                        interval_1 = 100;\n                        timeout = 10000;\n                        time = 0;\n                        _a.label = 2;\n                    case 2:\n                        if (!(time < timeout)) return [3 /*break*/, 4];\n                        if (this.encryptionKey.length !== 0) {\n                            return [2 /*return*/, this.encryptionKey];\n                        }\n                        return [4 /*yield*/, new Promise(function (r) { return setTimeout(r, interval_1); })];\n                    case 3:\n                        _a.sent();\n                        time += interval_1;\n                        return [3 /*break*/, 2];\n                    case 4: return [3 /*break*/, 7];\n                    case 5:\n                        err_1 = _a.sent();\n                        throw new Error(\"\".concat((0, utils_1.timestamp)(), \": failed to watch encryptionKey update\"));\n                    case 6:\n                        this._requestEncryptionKeyInProgress = false;\n                        return [7 /*endfinally*/];\n                    case 7: throw new Error(\"\".concat((0, utils_1.timestamp)(), \": timedout waiting for encryption key from clients\"));\n                }\n            });\n        });\n    };\n    return EncryptionKeyChannelWorker;\n}());\nexports.EncryptionKeyChannelWorker = EncryptionKeyChannelWorker;\n\n\n//# sourceURL=webpack:///../js/channels/encryptionKey.ts?");

/***/ }),

/***/ "../js/crypto/chacha20Decryptor.ts":
/*!*****************************************!*\
  !*** ../js/crypto/chacha20Decryptor.ts ***!
  \*****************************************/
/***/ ((__unused_webpack_module, exports, __webpack_require__) => {

eval("\nObject.defineProperty(exports, \"__esModule\", ({ value: true }));\nexports.decryptChunk = exports.newDecryptTransformer = exports.newChaCha20Decryptor = void 0;\nvar ts_chacha20_1 = __webpack_require__(/*! ts-chacha20 */ \"../../node_modules/ts-chacha20/build/src/chacha20.js\");\nvar padding = new TextEncoder().encode(\"00000000000000000000000000000000000000000000000000000000000000000\");\nfunction newChaCha20Decryptor(encryptionKey, nonce, offset) {\n    var counter = Math.floor(offset / 64);\n    var byteCounter = offset % 64;\n    var textEncoder = new TextEncoder();\n    var decryptor = new ts_chacha20_1.Chacha20(textEncoder.encode(encryptionKey), textEncoder.encode(nonce), counter);\n    // set the internal byte counter\n    if (byteCounter !== 0) {\n        decryptor.decrypt(padding.slice(0, byteCounter));\n    }\n    return decryptor;\n}\nexports.newChaCha20Decryptor = newChaCha20Decryptor;\nvar newDecryptTransformer = function (decryptor) {\n    return new TransformStream({\n        start: function () { },\n        transform: function (chunk, controller) {\n            var decryptedChunk = (0, exports.decryptChunk)(chunk, decryptor);\n            controller.enqueue(decryptedChunk);\n        },\n        flush: function () { },\n    });\n};\nexports.newDecryptTransformer = newDecryptTransformer;\nvar decryptChunk = function (input, decryptor) {\n    var decrypted = decryptor.decrypt(input);\n    return decrypted;\n};\nexports.decryptChunk = decryptChunk;\n\n\n//# sourceURL=webpack:///../js/crypto/chacha20Decryptor.ts?");

/***/ }),

/***/ "../js/crypto/fetchInterceptor.ts":
/*!****************************************!*\
  !*** ../js/crypto/fetchInterceptor.ts ***!
  \****************************************/
/***/ (function(__unused_webpack_module, exports, __webpack_require__) {

eval("\nvar __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {\n    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }\n    return new (P || (P = Promise))(function (resolve, reject) {\n        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }\n        function rejected(value) { try { step(generator[\"throw\"](value)); } catch (e) { reject(e); } }\n        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }\n        step((generator = generator.apply(thisArg, _arguments || [])).next());\n    });\n};\nvar __generator = (this && this.__generator) || function (thisArg, body) {\n    var _ = { label: 0, sent: function() { if (t[0] & 1) throw t[1]; return t[1]; }, trys: [], ops: [] }, f, y, t, g;\n    return g = { next: verb(0), \"throw\": verb(1), \"return\": verb(2) }, typeof Symbol === \"function\" && (g[Symbol.iterator] = function() { return this; }), g;\n    function verb(n) { return function (v) { return step([n, v]); }; }\n    function step(op) {\n        if (f) throw new TypeError(\"Generator is already executing.\");\n        while (g && (g = 0, op[0] && (_ = 0)), _) try {\n            if (f = 1, y && (t = op[0] & 2 ? y[\"return\"] : op[0] ? y[\"throw\"] || ((t = y[\"return\"]) && t.call(y), 0) : y.next) && !(t = t.call(y, op[1])).done) return t;\n            if (y = 0, t) op = [op[0] & 2, t.value];\n            switch (op[0]) {\n                case 0: case 1: t = op; break;\n                case 4: _.label++; return { value: op[1], done: false };\n                case 5: _.label++; y = op[1]; op = [0]; continue;\n                case 7: op = _.ops.pop(); _.trys.pop(); continue;\n                default:\n                    if (!(t = _.trys, t = t.length > 0 && t[t.length - 1]) && (op[0] === 6 || op[0] === 2)) { _ = 0; continue; }\n                    if (op[0] === 3 && (!t || (op[1] > t[0] && op[1] < t[3]))) { _.label = op[1]; break; }\n                    if (op[0] === 6 && _.label < t[1]) { _.label = t[1]; t = op; break; }\n                    if (t && _.label < t[2]) { _.label = t[2]; _.ops.push(op); break; }\n                    if (t[2]) _.ops.pop();\n                    _.trys.pop(); continue;\n            }\n            op = body.call(thisArg, _);\n        } catch (e) { op = [6, e]; y = 0; } finally { f = t = 0; }\n        if (op[0] & 5) throw op[1]; return { value: op[0] ? op[1] : void 0, done: true };\n    }\n};\nObject.defineProperty(exports, \"__esModule\", ({ value: true }));\nexports.internalFetch = void 0;\nvar request_1 = __webpack_require__(/*! ../request */ \"../js/request.ts\");\nvar chacha20Decryptor_1 = __webpack_require__(/*! ./chacha20Decryptor */ \"../js/crypto/chacha20Decryptor.ts\");\nfunction getNonceFromUrl(url) {\n    var nonce = \"\";\n    if (url.indexOf(\"/v1/media/\") !== -1) {\n        nonce = url.substring(url.indexOf(\"/v1/media/\") + \"/v1/media/\".length);\n    }\n    if (url.indexOf(\"/v1/thumbnail/\") !== -1) {\n        nonce = url.substring(url.indexOf(\"/v1/thumbnail/\") + \"/v1/thumbnail/\".length);\n    }\n    console.log(\"nonce\", nonce);\n    if (nonce.length === 0) {\n        throw new Error(\"invalid url\");\n    }\n    nonce = nonce.substring(0, 12);\n    return nonce;\n}\n// todo better name\nfunction internalFetch(req, encryptionKeyGetter) {\n    return __awaiter(this, void 0, void 0, function () {\n        var range, offset, nonce, encryptionKey, decryptor, res, encryptedStream, decryptedStream, err_1;\n        return __generator(this, function (_a) {\n            switch (_a.label) {\n                case 0:\n                    console.debug(\"[internalFetch] \".concat(req.url));\n                    range = (0, request_1.getRequestRange)(req.headers);\n                    offset = range !== undefined ? range.start : 0;\n                    _a.label = 1;\n                case 1:\n                    _a.trys.push([1, 4, , 5]);\n                    nonce = getNonceFromUrl(req.url);\n                    return [4 /*yield*/, encryptionKeyGetter()];\n                case 2:\n                    encryptionKey = _a.sent();\n                    decryptor = (0, chacha20Decryptor_1.newChaCha20Decryptor)(encryptionKey, nonce, offset);\n                    return [4 /*yield*/, fetch(req)];\n                case 3:\n                    res = _a.sent();\n                    encryptedStream = res.body;\n                    if (encryptedStream === null) {\n                        return [2 /*return*/, new Response(undefined, {\n                                status: 500,\n                            })];\n                    }\n                    decryptedStream = encryptedStream.pipeThrough((0, chacha20Decryptor_1.newDecryptTransformer)(decryptor));\n                    return [2 /*return*/, new Response(decryptedStream, {\n                            headers: res.headers,\n                            status: res.status,\n                            statusText: res.statusText,\n                        })];\n                case 4:\n                    err_1 = _a.sent();\n                    console.log(err_1);\n                    return [2 /*return*/, new Response(undefined, {\n                            status: 500,\n                        })];\n                case 5: return [2 /*return*/];\n            }\n        });\n    });\n}\nexports.internalFetch = internalFetch;\n\n\n//# sourceURL=webpack:///../js/crypto/fetchInterceptor.ts?");

/***/ }),

/***/ "../js/request.ts":
/*!************************!*\
  !*** ../js/request.ts ***!
  \************************/
/***/ ((__unused_webpack_module, exports) => {

eval("\nObject.defineProperty(exports, \"__esModule\", ({ value: true }));\nexports.parseResponseRangeHeader = exports.parseRequestRangeHeader = exports.getRequestRange = void 0;\nfunction getRequestRange(headers) {\n    var rangeHeader = headers.get(\"Range\");\n    if (rangeHeader === null) {\n        return undefined;\n    }\n    return parseRequestRangeHeader(rangeHeader);\n}\nexports.getRequestRange = getRequestRange;\nfunction parseRequestRangeHeader(range) {\n    var parts = range.split(\"=\");\n    if (parts.length != 2) {\n        throw new Error(\"Invalid range header \" + range);\n    }\n    var unit = parts[0];\n    var rangePart = parts[1];\n    var end = -1;\n    if (rangePart.split(\"-\").length === 2 &&\n        rangePart.split(\"-\")[1].length !== 0) {\n        end = Number(rangePart.split(\"-\")[1]);\n    }\n    var start = Number(rangePart.split(\"-\")[0]);\n    return {\n        unit: unit,\n        start: start,\n        end: end,\n    };\n}\nexports.parseRequestRangeHeader = parseRequestRangeHeader;\nfunction parseResponseRangeHeader(range) {\n    var parts = range.split(\" \");\n    if (parts.length != 2) {\n        throw new Error(\"Invalid range header \" + range);\n    }\n    var unit = parts[0];\n    // rangeSizePart = 200-1000/67589\n    var rangeSizePart = parts[1];\n    parts = rangeSizePart.split(\"/\");\n    if (parts.length != 2) {\n        throw new Error(\"Invalid range header \" + range);\n    }\n    var size = Number(parts[1]);\n    // rangePart = 200-1000\n    var rangePart = parts[0];\n    if (rangePart.split(\"-\").length != 2) {\n        throw new Error(\"Invalid range header \" + range);\n    }\n    var start = Number(rangePart.split(\"-\")[0]);\n    var end = Number(rangePart.split(\"-\")[1]);\n    return {\n        unit: unit,\n        start: start,\n        end: end,\n        size: size,\n    };\n}\nexports.parseResponseRangeHeader = parseResponseRangeHeader;\n\n\n//# sourceURL=webpack:///../js/request.ts?");

/***/ }),

/***/ "../js/utils.ts":
/*!**********************!*\
  !*** ../js/utils.ts ***!
  \**********************/
/***/ (function(__unused_webpack_module, exports) {

eval("\nvar __extends = (this && this.__extends) || (function () {\n    var extendStatics = function (d, b) {\n        extendStatics = Object.setPrototypeOf ||\n            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||\n            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };\n        return extendStatics(d, b);\n    };\n    return function (d, b) {\n        if (typeof b !== \"function\" && b !== null)\n            throw new TypeError(\"Class extends value \" + String(b) + \" is not a constructor or null\");\n        extendStatics(d, b);\n        function __() { this.constructor = d; }\n        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());\n    };\n})();\nObject.defineProperty(exports, \"__esModule\", ({ value: true }));\nexports.promiseTimeout = exports.PromiseTimeoutError = exports.getQueryParamStringValue = exports.timestamp = exports.base64UrlDecode = exports.base64UrlEncode = void 0;\n// todo throw error?\nfunction base64UrlEncode(data) {\n    try {\n        if (data === undefined) {\n            return undefined;\n        }\n        return window.btoa(JSON.stringify(data));\n    }\n    catch (err) {\n        console.error(err);\n        return \"\";\n    }\n}\nexports.base64UrlEncode = base64UrlEncode;\n// todo throw error?\nfunction base64UrlDecode(data) {\n    try {\n        if (data === undefined) {\n            return undefined;\n        }\n        return JSON.parse(window.atob(data));\n    }\n    catch (err) {\n        console.error(err);\n        return \"\";\n    }\n}\nexports.base64UrlDecode = base64UrlDecode;\nfunction timestamp() {\n    var date = new Date();\n    return \"\".concat(date.getHours().toString().padStart(2, \"0\"), \":\").concat(date\n        .getMinutes()\n        .toString()\n        .padStart(2, \"0\"), \":\").concat(date.getSeconds().toString().padStart(2, \"0\"), \".\").concat(date\n        .getMilliseconds()\n        .toString()\n        .padEnd(3, \"0\"));\n}\nexports.timestamp = timestamp;\nfunction getQueryParamStringValue(query, key, defaultValue) {\n    try {\n        var queryParam = query[key];\n        if (queryParam && typeof queryParam === \"string\") {\n            return queryParam;\n        }\n        else {\n            return defaultValue;\n        }\n    }\n    catch (err) {\n        return defaultValue;\n    }\n}\nexports.getQueryParamStringValue = getQueryParamStringValue;\nvar PromiseTimeoutError = /** @class */ (function (_super) {\n    __extends(PromiseTimeoutError, _super);\n    function PromiseTimeoutError() {\n        return _super !== null && _super.apply(this, arguments) || this;\n    }\n    return PromiseTimeoutError;\n}(Error));\nexports.PromiseTimeoutError = PromiseTimeoutError;\nfunction promiseTimeout(promise, timeoutMS) {\n    var timer;\n    return Promise.race([\n        promise,\n        new Promise(function (_, reject) {\n            timer = setTimeout(reject, timeoutMS, new PromiseTimeoutError(\"timeout waiting for promise\"));\n        }),\n    ]).finally(function () {\n        clearTimeout(timer);\n    });\n}\nexports.promiseTimeout = promiseTimeout;\n\n\n//# sourceURL=webpack:///../js/utils.ts?");

/***/ }),

/***/ "./decrypt.ts":
/*!********************!*\
  !*** ./decrypt.ts ***!
  \********************/
/***/ ((__unused_webpack_module, exports, __webpack_require__) => {

eval("\nObject.defineProperty(exports, \"__esModule\", ({ value: true }));\nvar encryptionKey_1 = __webpack_require__(/*! ../js/channels/encryptionKey */ \"../js/channels/encryptionKey.ts\");\nvar fetchInterceptor_1 = __webpack_require__(/*! ../js/crypto/fetchInterceptor */ \"../js/crypto/fetchInterceptor.ts\");\nself.addEventListener(\"install\", function () {\n    self.skipWaiting();\n});\nself.addEventListener(\"activate\", function (event) {\n    event.waitUntil(self.clients.claim());\n});\nvar map = new Map();\nself.onmessage = function (event) {\n    // We send a heartbeat every x second to keep the\n    // service worker alive if a transferable stream is not sent\n    if (event.data === \"ping\") {\n        return;\n    }\n    var data = event.data;\n    var downloadUrl = data.url ||\n        self.registration.scope +\n            Math.random() +\n            \"/\" +\n            (typeof data === \"string\" ? data : data.filename);\n    var port = event.ports[0];\n    var metadata = new Array(3); // [stream, data, port]\n    metadata[1] = data;\n    metadata[2] = port;\n    // Note to self:\n    // old streamsaver v1.2.0 might still use `readableStream`...\n    // but v2.0.0 will always transfer the stream through MessageChannel #94\n    if (event.data.readableStream) {\n        metadata[0] = event.data.readableStream;\n    }\n    else if (event.data.transferringReadable) {\n        port.onmessage = function (evt) {\n            port.onmessage = null;\n            metadata[0] = evt.data.readableStream;\n        };\n    }\n    else {\n        metadata[0] = createStream(port);\n    }\n    map.set(downloadUrl, metadata);\n    port.postMessage({ download: downloadUrl });\n};\nfunction createStream(port) {\n    // ReadableStream is only supported by chrome 52\n    return new ReadableStream({\n        start: function (controller) {\n            // When we receive data on the messageChannel, we write\n            port.onmessage = function (_a) {\n                var data = _a.data;\n                if (data === \"end\") {\n                    return controller.close();\n                }\n                if (data === \"abort\") {\n                    controller.error(\"Aborted the download\");\n                    return;\n                }\n                controller.enqueue(data);\n            };\n        },\n        cancel: function (reason) {\n            console.log(\"user aborted\", reason);\n            port.postMessage({ abort: true });\n        },\n    });\n}\n// *************************\n// ****custom code start****\n// *************************\nvar encryptionKeyChannel = new encryptionKey_1.EncryptionKeyChannelWorker();\n// *************************\n// ****custom code end******\n// *************************\nself.onfetch = function (event) {\n    var _a, _b;\n    var url = event.request.url;\n    // this only works for Firefox\n    if (url.endsWith(\"/ping\")) {\n        return event.respondWith(new Response(\"pong\"));\n    }\n    // *************************\n    // ****custom code start****\n    // *************************\n    var urlObj = new URL(url);\n    if (((_a = event === null || event === void 0 ? void 0 : event.request) === null || _a === void 0 ? void 0 : _a.method) === \"GET\" &&\n        typeof ((_b = event === null || event === void 0 ? void 0 : event.request) === null || _b === void 0 ? void 0 : _b.url) === \"string\" &&\n        (urlObj.pathname.indexOf(\"/v1/media/\") !== -1 ||\n            urlObj.pathname.indexOf(\"/v1/thumbnail/\") !== -1)) {\n        return event.respondWith((0, fetchInterceptor_1.internalFetch)(event.request, function () {\n            return new Promise(function (resolve, reject) {\n                encryptionKeyChannel\n                    .requestEncryptionKey()\n                    .then(function (key) {\n                    resolve(key);\n                })\n                    .catch(function (err) { return reject(err); });\n            });\n        }));\n    }\n    // *************************\n    // ****custom code end******\n    // *************************\n    var hijacke = map.get(url);\n    if (!hijacke) {\n        return null;\n    }\n    var stream = hijacke[0], data = hijacke[1], port = hijacke[2];\n    map.delete(url);\n    // Not comfortable letting any user control all headers\n    // so we only copy over the length & disposition\n    var responseHeaders = new Headers({\n        \"Content-Type\": \"application/octet-stream; charset=utf-8\",\n        // To be on the safe side, The link can be opened in a iframe.\n        // but octet-stream should stop it.\n        \"Content-Security-Policy\": \"default-src 'none'\",\n        \"X-Content-Security-Policy\": \"default-src 'none'\",\n        \"X-WebKit-CSP\": \"default-src 'none'\",\n        \"X-XSS-Protection\": \"1; mode=block\",\n    });\n    var headers = new Headers(data.headers || {});\n    {\n        var contentLength = headers.get(\"Content-Length\");\n        if (contentLength != null) {\n            responseHeaders.set(\"Content-Length\", contentLength);\n        }\n    }\n    {\n        var contentDisposition = headers.get(\"Content-Disposition\");\n        if (contentDisposition != null) {\n            responseHeaders.set(\"Content-Disposition\", contentDisposition);\n        }\n    }\n    // data, data.filename and size should not be used anymore\n    if (data.size) {\n        console.warn(\"Depricated\");\n        responseHeaders.set(\"Content-Length\", data.size);\n    }\n    var fileName = typeof data === \"string\" ? data : data.filename;\n    if (fileName) {\n        console.warn(\"Depricated\");\n        // Make filename RFC5987 compatible\n        fileName = encodeURIComponent(fileName)\n            .replace(/['()]/g, escape)\n            .replace(/\\*/g, \"%2A\");\n        responseHeaders.set(\"Content-Disposition\", \"attachment; filename*=UTF-8''\" + fileName);\n    }\n    event.respondWith(new Response(stream, { headers: responseHeaders }));\n    port.postMessage({ debug: \"Download started\" });\n};\n\n\n//# sourceURL=webpack:///./decrypt.ts?");

/***/ })

/******/ 	});
/************************************************************************/
/******/ 	// The module cache
/******/ 	var __webpack_module_cache__ = {};
/******/ 	
/******/ 	// The require function
/******/ 	function __webpack_require__(moduleId) {
/******/ 		// Check if module is in cache
/******/ 		var cachedModule = __webpack_module_cache__[moduleId];
/******/ 		if (cachedModule !== undefined) {
/******/ 			return cachedModule.exports;
/******/ 		}
/******/ 		// Create a new module (and put it into the cache)
/******/ 		var module = __webpack_module_cache__[moduleId] = {
/******/ 			// no module.id needed
/******/ 			// no module.loaded needed
/******/ 			exports: {}
/******/ 		};
/******/ 	
/******/ 		// Execute the module function
/******/ 		__webpack_modules__[moduleId].call(module.exports, module, module.exports, __webpack_require__);
/******/ 	
/******/ 		// Return the exports of the module
/******/ 		return module.exports;
/******/ 	}
/******/ 	
/************************************************************************/
/******/ 	
/******/ 	// startup
/******/ 	// Load entry module and return exports
/******/ 	// This entry module can't be inlined because the eval devtool is used.
/******/ 	var __webpack_exports__ = __webpack_require__("./decrypt.ts");
/******/ 	
/******/ })()
;